{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"pubsub/FAQ/","title":"PubSub FAQs","text":""},{"location":"pubsub/FAQ/#overview","title":"Overview","text":"<p>The purpose of this document is to answer commonly asked questions about using PubSub at Ford. If you have a question not discussed or require clarification please join the:</p> <p>Kafka PubSub Teams Space</p>"},{"location":"pubsub/FAQ/#questions-answers","title":"Questions &amp; Answers","text":""},{"location":"pubsub/FAQ/#1-how-to-setup-push-subscriptions","title":"1. How to setup Push Subscriptions","text":"<p>Refer to tfm github repo https://github.ford.com/gcp/tfm-pubsub#disclaimer-to-all-pubsub-push-subscription-users</p>"},{"location":"pubsub/FAQ/#2-publicly-accessible-topic","title":"2. Publicly accessible topic","text":"<p>Refer to the following link https://github.ford.com/gcp/tfm-pubsub#publicly-accessible-pubsub-topic </p>"},{"location":"pubsub/FAQ/#3-what-regions-are-available-currently-in-gcp-pubsub","title":"3. What regions are available currently in GCP PubSub?","text":"<ol> <li> <p>US Central 1 and US East 4 </p> </li> <li> <p>How to provision for multi region? (Please check with Kafka/PubSub team) </p> </li> </ol>"},{"location":"pubsub/FAQ/#4-how-do-i-provision-my-project-in-20","title":"4. How do I provision my project in 2.0","text":"<p>Customers need to put in request via FCP portal.  Please refer to the link https://www.cloudportal.ford.com/multi-cloud to create project </p>"},{"location":"pubsub/FAQ/#5-dead-letter-topic-terraform-examples","title":"5. Dead Letter Topic terraform examples","text":"<p>Please refer to github link https://github.ford.com/gcp/tfm-pubsub/tree/master/examples  for both example on push and pull </p>"},{"location":"pubsub/FAQ/#6-we-are-working-on-creating-a-gcp-pubsub-topic-and-subscription-in-our-qa-project-using-terraform-but-we-are-facing-the-below-error","title":"6. We are working on creating a GCP pubsub topic and subscription in our QA project using terraform, but we are facing the below error:","text":"<p><code>in terraform-apply stage [terraform-cli] Error: Error creating Topic: googleapi: Error 403: Cloud Pub/Sub API has not been used in project ID before or it is disabled. Enable it by visiting https://console.developers.google.com/apis/api/pubsub.googleapis.com/overview?project=projectnumber then retry. If you enabled this API recently, wait a few minutes for the action to propagate to our systems and retry.</code></p> <p>APIs need to be enabled through FCP </p>"},{"location":"pubsub/FAQ/#7-does-a-pipeline-service-account-need-the-ford-cloud-pubsub-service-write-role-in-order-to-create-pubsub-resources-using-that-module","title":"7. Does a pipeline service account need the Ford Cloud PubSub Service write role in order to create PubSub resources using that module","text":"<p>That service account needs provisioner role</p>"},{"location":"pubsub/FAQ/#8-how-to-integrate-pubsub-with-dataflow","title":"8. How to Integrate PubSub with Dataflow","text":"<p>Please visit the link below to find more information on this: https://cloud.google.com/architecture/deploying-production-ready-log-exports-to-splunk-using-dataflow </p>"},{"location":"pubsub/FAQ/#9-we-are-facing-permission-denied-error-while-publishing-message-to-pubsub-from-cloud-run-do-we-need-to-provide-roles-in-iamserviceaccounttokencreator-access-to-service-account","title":"9. We are facing permission denied error while publishing message to pubsub from cloud run. Do we need to provide roles in iam.serviceAccountTokenCreator access to Service account","text":"<p>The service account (in this case Cloud run SA) Should have publisher role to the topic and you can either use terraform or bind via FCP. </p>"},{"location":"pubsub/FAQ/#10-can-you-provide-us-the-terraform-link-for-pubsub","title":"10. Can you provide us the terraform link for PubSub","text":"<p>https://github.ford.com/gcp/tfm-pubsub </p>"},{"location":"pubsub/FAQ/#11-we-are-trying-to-publish-an-event-from-spring-boot-project-to-google-pubsub-service-can-someone-help-me-implement-this-or-if-there-is-any-material-or-doc-to-follow-can-you-please-share-it-with-me","title":"11. We are trying to publish an event from spring boot project to google pubsub service. Can someone help me implement this? or If there is any material or doc to follow can you please share it with me?","text":"<p>We do not have client specific documentation, you can start reading through spring documentation for pubsub publisher/subscriber  - https://spring.io/guides/gs/messaging-gcp-pubsub/</p> <p>We can help you on how you can authenticate or autorize to your pubsub topic from clients</p>"},{"location":"pubsub/FAQ/#12-how-to-listen-pubsub-from-project-to-project","title":"12. How to listen pubsub from project to project","text":"<p>You will access the pub sub subscription to access topic in another project will be similar to accessing topic in your own project. You need to request source project to provide access to service account which you will use to provision your subscription</p> <pre><code>&gt;1. Project A that owns the topic must provide \u201cSubscriber Role\u201d to the service account  of Project B. Access is provided at resource level using terraform, in this case to a particular topic, in order to achieve Granular Access.\n\n&gt;2. Project B also need to have \u201cProvisioner Role\u201d in their own project in case they want to create the subscription.\n</code></pre> <p>Please refer the documentation for more details - https://github.ford.com/fordpubsub/tfm-pubsub/tree/master/examples/pubsub_granular_Control  </p>"},{"location":"pubsub/FAQ/#13-the-messages-in-pubsub-are-not-consuming-fast-for-the-service-deployed-in-cloud-run-is-there-any-way-to-scale-up-pubsub-or-any-another-configurations-to-consume-the-messages-quickly","title":"13. The messages in pubsub are not consuming fast for the service deployed in cloud run. Is there any way to scale up pubsub or any another configurations to consume the messages quickly","text":"<p>One way to achieve higher/faster consumption of messages is to send them out in batches as it would help to increase throughput. Also if your subscriber is running on cloud run then go for a push subscription instead of pull subscription</p>"},{"location":"pubsub/FAQ/#14-we-had-our-kafka-topic-created-for-10-gcp-projects-now-we-have-created-20-projects-would-like-to-know-the-process-to-onboard-our-new-projects-on-kafka-platform-so-that-we-can-create-topic-for-new-projects","title":"14. We had our kafka topic created for 1.0 gcp projects. Now we have created 2.0 projects. Would like to know the process to onboard our new projects on kafka platform so that we can create topic for new projects.","text":"<p>Eventhough you provide your gcp project during onboarding in the ticket, there is no link between gcp project and kafka. So you can use the same topic even from your gcp project 2.0 without any issue.</p>"},{"location":"pubsub/FAQ/#15-using-pubsub-if-we-do-originalmessagenack-incase-of-exception-will-that-message-forwarded-to-deadletterqueue-without-any-retries","title":"15. Using Pubsub if we do originalMessage.nack() incase of exception, will that message forwarded to deadletterqueue without any retries","text":"<p>No our understanding even if you nack() the message it will retry for mentioned number if times before moving the message to DLQ.</p> <p>If the client holds the message beyond the agreed deadline without acking, or if the client sends a nack (negative acknowledgement) request, the message will be redelivered (potentially to a different subscriber on the same subscription).</p>"},{"location":"pubsub/FAQ/#16-we-are-trying-to-invoke-a-cloud-run-api-on-a-scheduled-basis-for-our-business-use-case-with-the-help-of-cloud-scheduler-via-pubsub-push-subscription-invoking-the-cloud-run-endpoint-url","title":"16. We are trying to invoke a cloud run API on a scheduled basis for our business use case with the help of Cloud Scheduler via PubSub Push Subscription invoking the Cloud Run endpoint URL","text":"<p>Can you try this example module how to push message from pubsub to cloud run - https://github.ford.com/gcp/tfm-pubsub/tree/master/examples/pubsub_push_cloudrun</p> <p>Can you please check if the service account you are using have the invoke permission in cloud run. Please refer this documentation you need to create push subscription with service account and make sure you provide that service account the cloud run invoke permission.</p> <p>https://cloud.google.com/run/docs/triggering/pubsub-push#create-push-subscription</p>"},{"location":"pubsub/FAQ/#17-what-permissions-are-needed-to-create-a-bigquery-subscription-through-the-web-interface","title":"17. What permissions are needed to create a Bigquery subscription through the web interface?","text":"<p>Grant the BigQuery Data Editor (roles/bigquery.dataEditor) role and the BigQuery Metadata Viewer (roles/bigquery.metadataViewer) role to the Pub/Sub service account.(also known as Pubsub service agent) More info can be found in the below links.  https://cloud.google.com/pubsub/docs/bigquery https://cloud.google.com/pubsub/docs/create-subscription#subscription</p>"},{"location":"pubsub/FAQ/#18-what-level-of-access-is-required-to-pull-messages-from-gcp-pub-sub","title":"18. What level of access is required to pull messages from GCP Pub-Sub","text":"<p>Pls ensure that the SA has subscriber role for that topic if its hosted in other project. source project should provide subscriber role to your SA project</p>"},{"location":"pubsub/FAQ/#19-we-are-trying-to-implement-google-pubsub-while-deploying-in-gke-getting-google_application_credentials-error-any-suggestion","title":"19. We are trying to implement google pub/sub While deploying in GKE getting GOOGLE_APPLICATION_CREDENTIALS error , any suggestion?","text":"<p>Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'topicAdminClient' defined in class path resource [com/google/cloud/spring/autoconfigure/pubsub/GcpPubSubAutoConfiguration.class]: Bean instantiation via factory method failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [com.google.cloud.pubsub.v1.TopicAdminClient]: Factory method 'topicAdminClient' threw exception; nested exception is com.google.cloud.spring.pubsub.core.PubSubException: An error occurred while creating TopicAdminClient.; nested exception is java.io.IOException: The Application Default Credentials are not available. They are available if running in Google Compute Engine. Otherwise, the environment variable GOOGLE_APPLICATION_CREDENTIALS must be defined pointing to a file defining the credentials. See https://developers.google.com/accounts/docs/application-default-credentials for more information.</p> <p>Please refer the document on how to authenticate to any GCP service when using GKE. https://cloud.google.com/docs/authentication/provide-credentials-adc#containerized</p> <p>You may have to use the Workload Identity  - https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity</p>"},{"location":"pubsub/FAQ/#20-permission-denied-trying-to-create-a-dataflow-from-the-template-pubsub-to-avro-files-on-cloud-storage","title":"20. Permission Denied trying to create a Dataflow from the template \"Pub/Sub to Avro Files on Cloud Storage\"?","text":"<p>You are missing on  permissions what dataflow requires to create a dataflow-pipeline, Please reachout to dan deewale : ddewael5@ford.com</p>"},{"location":"pubsub/FAQ/#21-trying-to-implement-dataflow-scheduler-using-cloud-scheduler-pubsub-cloud-run-it-looks-like-we-can-not-put-message-in-cloud-scheduler-pubsub-topic-as-the-data-variable-is-not-used-is-there-a-work-around-the-cloud-scheduler-integration-with-pubsub-doesnt-have-data-field-enabled-in-the-repo-as-of-now-it-sends-data-as-test-hard-coded-can-this-be-exposed-for-the-users-to-assign-needed-data-values","title":"21. Trying to implement dataflow scheduler using Cloud Scheduler - pubsub - cloud run. It looks like we can not put message in cloud scheduler pubsub topic as the data variable is not used. Is there a work around? the cloud scheduler integration with pubsub doesn't have data field enabled in the repo. As of now it sends data as \"test\" hard coded. Can this be exposed for the users to assign needed data values?","text":"<p>As this feature what you are asking is part of scheduler module - https://github.ford.com/gcp/tfm-scheduler. This is managed by different team you need to work with cloud scheduler team to get this change updated in their module</p> <p>Additional info:  Terraform module that will guide how to publish to pub/sub topic using cloud scheduler - https://github.ford.com/gcp/tfm-pubsub/blob/master/examples/cloud-scheduler/scheduler.tf. How to push the message to cloud run using push subscription - https://github.ford.com/gcp/tfm-pubsub/tree/master/examples/pubsub_push_cloudrun</p>"},{"location":"pubsub/FAQ/#22-trying-to-create-a-log-sink-at-the-folder-level-and-have-that-log-sink-publish-to-a-pubsub-topic-originally-we-were-getting-a-topic_org_policy_denied-since-then-we-have-updated-the-writer-identity-to-have-the-correct-permissions-we-are-now-getting-a-permission-denied-any-help-would-be-much-appreciated","title":"22. Trying to create a log sink at the folder level and have that log sink publish to a pubsub topic. Originally we were getting a topic_org_policy_denied. Since then we have updated the writer identity to have the correct permissions. We are now getting a permission denied. Any help would be much appreciated.","text":"<p>you need logging.viewer and logging.privateLogViewer permissions added to the account</p>"},{"location":"pubsub/FAQ/#23-where-can-i-get-more-help-on-terraform","title":"23. Where can I get more help on Terraform?","text":"<p>For any Terraform related issue please reach out to GCP DevOps Dojo and Community Support Form -  https://www.webexteams.ford.com/space?r=m1gv</p> <p>Refer the link for documentation - https://docs.gcp.ford.com/docs/support/local-dev/</p>"},{"location":"pubsub/FAQ/#24-where-can-i-find-the-pubsub-service-account-that-was-created-when-i-selected-the-service-for-my-project","title":"24. Where can I find the pubsub service account that was created when I selected the service for my project?","text":"<p>Go to IAM in GCP project, then Check the check box on the right side of the IAM UI where it says Google provided roles and grants. Then Scroll to very bottom and you will find a pubsub service agent with below naming convention. Service-your_project_id@ Select one which contains pubsub after \"@\".</p>"},{"location":"pubsub/FAQ/#25-getting-this-error-while-creating-a-topic-with-pull-subscriptions-this-is-only-happening-for-the-topic-which-has-dead-letter-flag-enabled-i-am-on-vpn-and-authenticated-also-other-topicwithout-dead-letter-reference-and-its-pull-subscriptions-are-created-in-the-same-terraform-apply","title":"25. getting this error while creating a topic with pull subscriptions. This is only happening for the topic which has dead letter flag enabled. I am on VPN and authenticated. also other topic(without dead letter reference) and its pull subscriptions are created in the same terraform apply","text":"<p>\u2502 Error: Error creating Subscription: googleapi: Error 403: Request is prohibited by organization's policy. vpcServiceControlsUniqueIdentifier: mt7Cjn3GV4mnxFVr4Mb4BAqhlr_L0uqRC8mRTOe77P9jQq8fyTQUYw \u2502 Details: \u2502 [ \u2502   { \u2502     \"@type\": \"type.googleapis.com/google.rpc.PreconditionFailure\", \u2502     \"violations\": [ \u2502       { \u2502         \"description\": \"mt7Cjn3GV4mnxFVr4Mb4BAqhlr_L0uqRC8mRTOe77P9jQq8fyTQUYw\", \u2502         \"type\": \"VPC_SERVICE_CONTROLS\" \u2502       } \u2502     ] \u2502   }, \u2502   { \u2502     \"@type\": \"type.googleapis.com/google.rpc.ErrorInfo\", \u2502     \"domain\": \"googleapis.com\", \u2502     \"metadata\": { \u2502       \"consumer\": \"projects/232007124988\", \u2502       \"service\": \"pubsub.googleapis.com\", \u2502       \"uid\": \"mt7Cjn3GV4mnxFVr4Mb4BAqhlr_L0uqRC8mRTOe77P9jQq8fyTQUYw\" \u2502     }, \u2502     \"reason\": \"SECURITY_POLICY_VIOLATED\" \u2502   } \u2502 ] \u2502  \u2502   with module.base.module.pubsub-vadr-release-topic.google_pubsub_subscription.pull_subscriptions[\"au-na\"], \u2502   on .terraform/modules/base.pubsub-vadr-release-topic/main.tf line 98, in resource \"google_pubsub_subscription\" \"pull_subscriptions\": \u2502   98: resource \"google_pubsub_subscription\" \"pull_subscriptions\" {</p> <p>need to provide the deadletter topic name in the below format</p> <p><code>projects/&lt;Project-id&gt;/topics/&lt;topic-name&gt;</code></p> <p>Please contact terraform SME for additional support. </p>"},{"location":"pubsub/FAQ/#26-unable-to-decode-the-published-messages-correctly","title":"26. Unable to decode the published messages correctly","text":"<p>PubSub treats the payload as a byte[]. The encoding and decoding should be up to you. If this is java, make sure you are defining the right character set in the byte[] to String logic. Perhaps python has something similar. </p>"},{"location":"pubsub/Overview/","title":"Google Cloud PubSub","text":""},{"location":"pubsub/Overview/#what-is-gcp-pubsub","title":"What is GCP PubSub ?","text":"<p>Pub/Sub is an asynchronous and scalable messaging service that decouples services producing messages from services processing those messages. Pub/Sub is used for streaming analytics and data integration pipelines to ingest and distribute data. It's equally effective as a messaging-oriented middleware for service integration or as a queue to parallelize tasks.</p> <p>Pub/Sub enables you to create systems of event producers and consumers, called publishers and subscribers. Publishers communicate with subscribers asynchronously by broadcasting events, rather than by synchronous remote procedure calls (RPCs).</p>"},{"location":"pubsub/Overview/#how-to-provision","title":"How to provision ?","text":"<p>You can provision topic and subscription by any of the below method</p> <ul> <li>gcloud cli</li> <li>terraform </li> </ul> <p>Terraform module with example can be found here - https://github.ford.com/gcp/tfm-pubsub</p>"},{"location":"pubsub/Overview/#how-to-provide-permission","title":"How to provide permission ?","text":"<p>You can request for pub/sub service through FCP portal. Below are the Ford custom role needed for publishing and subscribing from pubsub topic</p> <ul> <li> <p>ford.cloud.pubsub.subscriber - Subscribe the message from a topic</p> </li> <li> <p>ford.cloud.pubsub.publisher - Publish message to a topic</p> </li> <li> <p>ford.cloud.pubsub.operator - When you enable the service you will get a default viewer role</p> </li> </ul>"},{"location":"pubsub/public-access-pubsub-service/","title":"Publicly Accessible Pub/Sub Topic","text":"<p>If your project has a business need for the publicly accessible Pub/Sub topic and need a VPC Service Control (Ingress/Egress) Policy, a signed Detailed Risk Assessment must first be completed by the project team.  In order to initiate the Assessment, a request can be filed HERE (more filing detail below).</p>"},{"location":"pubsub/public-access-pubsub-service/#for-detailed-risk-assessment-request","title":"For Detailed Risk Assessment request:","text":"<ul> <li>Click Here</li> <li>Click <code>\u2018IT Help\u2019</code></li> <li>Click <code>\u2018Submit a Ticket\u2019</code></li> <li>Search for <code>\u201cRisk Assessment\u201d</code></li> <li>In the line\u2026</li> </ul> <ul> <li> <p>Click <code>\u201cRequest Now\u201d</code></p> </li> <li> <p>Make these initial choices\u2026</p> </li> </ul> <p></p> <ul> <li> <p>And fill in the rest specific to your application.  Include that the purpose of the analysis is to measure the risks of Publicly Accessible Pub/Sub topics that are located within our Ford.com VPC Perimeter.</p> </li> <li> <p>Click <code>\u2018Submit Request\u2019</code></p> </li> </ul>"},{"location":"pubsub/public-access-pubsub-service/#step3","title":"Step3:","text":"<p>The VPC Service Controls rule necessary to resolve the error is an Ingress rule, which will be applied by VPC Service Control team. </p>"},{"location":"pubsub/public-access-pubsub-service/#example-ingress-rule","title":"Example Ingress Rule:","text":"<p>Sample VPCSC Request: REQ000004671596</p>"},{"location":"pubsub/public-access-pubsub-service/#place-the-below-code-snippet-within-both-dry-run-and-enforce-vpc-perimeters","title":"Place the below code snippet within both Dry Run and Enforce VPC Perimeters.","text":""},{"location":"pubsub/public-access-pubsub-service/#method-needed-for-subscription","title":"Method needed for Subscription:","text":"<pre><code>        {method = \"Subscriber.Pull\"},\n        {method = \"Subscriber.Seek\"},\n        {method = \"Subscriber.Acknowledge\"},\n        {method = \"Subscriber.StreamingPull\"},\n        {method = \"Subscriber.GetSubscription\"},\n        {method = \"Subscriber.ModifyAckDeadline\"},\n        {method = \"SubscriberService.Pull\"},\n        {method = \"SubscriberService.Acknowledge\"},\n</code></pre> <pre><code>{\n        from = {\n          identity_type = \"IDENTITY_TYPE_UNSPECIFIED\"\n          identities = [\"serviceAccount:vault-SA-Name@prj-example.iam.gserviceaccount.com\"]\n          sources    = { access_level = \"*\" }\n        }\n        to = {\n          resources = [\"projects/123456789\"]\n          operations = [{\n            service_name = \"pubsub.googleapis.com\"\n            #Specifying Specific PubSub Methods that an External Customer can use\n            method_selectors = [\n            {method = \"Subscriber.Pull\"},\n            {method = \"Subscriber.Seek\"},\n            {method = \"Subscriber.Acknowledge\"},\n            {method = \"Subscriber.StreamingPull\"},\n            {method = \"Subscriber.GetSubscription\"},\n            {method = \"Subscriber.ModifyAckDeadline\"},\n            {method = \"SubscriberService.Pull\"},\n            {method = \"SubscriberService.Acknowledge\"},\n            {method = \"Publisher.GetTopic\"}\n            ]\n          }]\n        }\n      },\n</code></pre>"},{"location":"pubsub/public-access-pubsub-service/#methods-to-be-added-to-ingress-for-a-publisher","title":"Methods to be added to Ingress for a Publisher:","text":"<pre><code>        {method = \"Publisher.GetTopic\"},\n        {method = \"Publisher.ListTopics\"},     \n        {method = \"PublisherService.ListTopics\"},\n        {method = \"PublisherService.Publish\"},\n        {method = \"PublisherService.PublishBatch\"},\n        {method = \"Publisher.Publish\"}\n</code></pre> <pre><code>{\n        from = {\n          identity_type = \"IDENTITY_TYPE_UNSPECIFIED\"\n          identities = [\"serviceAccount:vault-SA-Name@prj-example.iam.gserviceaccount.com\"]\n          sources    = { access_level = \"*\" }\n        }\n        to = {\n          resources = [\"projects/123456789\"]\n          operations = [{\n            service_name = \"pubsub.googleapis.com\"\n            #Specifying Specific PubSub Methods that an External Customer can use\n            method_selectors = [\n            {method = \"Publisher.ListTopics\"},\n            {method = \"PublisherService.ListTopics\"},\n            {method = \"PublisherService.Publish\"},\n            {method = \"PublisherService.PublishBatch\"},\n            {method = \"Publisher.Publish\"},\n            {method = \"Publisher.GetTopic\"}\n            ]\n          }]\n        }\n      },\n</code></pre>"},{"location":"pubsub/pubsub-day2-operations/","title":"Day 2 Operations","text":""},{"location":"pubsub/pubsub-day2-operations/#how-to-contact-ito-service-team-for-any-pubsub-queries","title":"How to contact ITO service team for any pubsub queries?","text":""},{"location":"pubsub/pubsub-day2-operations/#how-to-modify-existing-the-topic-and-subscription","title":"How to modify existing the topic and subscription ?","text":""},{"location":"pubsub/pubsub-day2-operations/#how-to-delete-topic-and-subscription","title":"How to delete topic and Subscription ?","text":""},{"location":"pubsub/pubsub-day2-operations/#how-to-provide-access-to-topic-to-service-account-in-different-project","title":"How to provide access to topic to service account in different project ?","text":""},{"location":"pubsub/pubsub-day2-operations/#how-to-monitoring-pubsub-services","title":"How to monitoring pub/sub services ?","text":""},{"location":"pubsub/pubsub-day2-operations/#frequently-encountered-issues-faqs","title":"Frequently Encountered Issues / FAQs ?","text":""},{"location":"pubsub/pubsub-migration-2_0/","title":"Pub/SubMigration to GCP Provisioner 2.0","text":""},{"location":"pubsub/pubsub-migration-2_0/#overview","title":"Overview","text":"<p>Ford GCP environment will be migrating to version 2.0. New Projects on-boarded after June 2022 are now using GCP Provisioner 2.0. Projects that have been built from GCP Provisioner 1.0 will have to migrate to 2.0.</p> <p>Migration will require the Application Teams to create a new V2.0 project.</p> <p>Next, provision a new Pub/Sub Infrastructure in V2.0 project that matches their V1.0 Pub/Sub Infrastructure.</p> <p>Finally, change the publishing and subscribing end point to new topics/subscription in V2.0 and validate.</p> <p>The following Sections address these steps.</p>"},{"location":"pubsub/pubsub-migration-2_0/#section-1-project-creation-using-gcp-provisioner-20","title":"Section 1: Project Creation using GCP Provisioner 2.0","text":""},{"location":"pubsub/pubsub-migration-2_0/#create-a-gcp-project-using-provisioner-20-through-fcp","title":"Create a GCP Project using Provisioner 2.0 through FCP.","text":"<p>To create a new project in FCP, follow the Self-Migration instructions.</p>"},{"location":"pubsub/pubsub-migration-2_0/#how-to-gcp-service-account-creation-and-usage","title":"How To : GCP Service Account Creation and Usage","text":"<p>https://azureford.sharepoint.com/:w:/r/sites/cloud/_layouts/15/Doc.aspx?sourcedoc=%7B227A057B-337D-4BDF-B88F-219601A14090%7D&amp;file=How%20To%20-%20GCP%20Service%20Account%20Creation%20and%20Usage.docx&amp;wdLOR=c38AB4B73-1C80-EE48-BBD6-C74DB49B41DC&amp;action=default&amp;mobileredirect=true</p>"},{"location":"pubsub/pubsub-migration-2_0/#gcp-self-service","title":"GCP Self Service","text":"Method Links Ford Cloud Portal https://www.cloudportal.ford.com/gcp Take GCP Degreed training for Terraform and Tekton GCP Degreed Training Perform GCP Checklist Tasks GCP Checklist ITO Tekton Pipeline for Terraform Repo Service Readiness Dashboard Link to available Terraform Modules, Service Owners &amp; FCP Status Create Service Account and IAM Bindings via Terraform How To - GCP Service Account Creation and Usage Create IAM Bindings via Terraform GCP How To - Give Permissions ITO GCP Learning Hub ITO GCP Learning Site Available ITO GCP architecture documents Guide to the Ford GCP Environment Ford GCP Technical Infrastructure Design GCP Services Decision Point Guide GCP Service HA/DR Ford GCP Service Account Strategy GCP Suppliers VDI Onboarding Guide"},{"location":"pubsub/pubsub-migration-2_0/#section-2-deploying-the-pubsub-topics-and-subscription-in-your-v20-project","title":"Section 2: Deploying the Pub/Sub Topics and Subscription in your V2.0 Project","text":"<p>This step involves running your existing V1.0 Terraform modules, in your V2.0 project, to provision your Topics and Subscriptions using Infrastructure as Code (IaC).</p>"},{"location":"pubsub/pubsub-migration-2_0/#pre-requisites","title":"Pre-requisites:","text":"<ol> <li>The person performing this step has knowledge about running Terraform to provision your Pub/Sub Infrastructure.</li> <li>Tools such as your Localdev, Tekton Pipeline, project GitHub containing V1.0 Terraform modules.</li> <li>Pub/Sub Permissions in v2.0 Project:</li> <li>ford.cloud.pubsub.provisioner for the Service Account.</li> <li>Other Pub/Sub roles that were granted to your V1.0 project</li> <li>In case if the Subscription of the topic is hosted on a different project, please request the subscriber to update the project details in the client.</li> </ol> <p>Note: Please find document on how to subscribe to a topic is different project: - https://github.ford.com/gcp/tfm-pubsub/tree/master/examples/pubsub_granular_Control </p>"},{"location":"pubsub/pubsub-migration-2_0/#provision-the-v20-pubsub-topics-and-subscriptions","title":"Provision the V2.0 Pub/Sub Topics and Subscriptions:","text":"<p>In your Terraform code, set your _ project_id _ variables to point to your V2.0 project.</p> <p>Deploy your Terraform code using the Tekton Pipeline to provision the new Pub/Sub Topics and Subscriptions in your V2.0 project. This will be provisioning the resources without data.</p>"},{"location":"pubsub/pubsub-migration-2_0/#section-3-update-publishing-topics-and-subscriber-details-in-application-client","title":"Section 3: Update Publishing topics and Subscriber details in Application client","text":"<p>Once Pub/Sub topics and subscriptions are created in GCP 2.0, you may need to update your publishing and subscribing client to point to new project_id</p> <p>You may need to execute the changes in the following order.</p> <p>Update all publish client to publish messages to new topic in provision 2.0 Check there are no unacknowledged message for the subscription using the monitoring dashboard</p> <p>Note: Please refer the terraform example on how to get the dashboard to monitor the metrics related to subscription</p> <p>Once all the messages are subscribed and acknowledged from the v1.0 subscription, update the application client to start subscribing from v2.0 subscriptions</p>"},{"location":"pubsub/pubsub-migration-2_0/#section-4-data-validation-in-the-v20-project","title":"Section 4: Data Validation in the V2.0 Project","text":"<p>Simple validation like topic and subscription metrics. Teams/Users can run their publishing and subscribing client to check the permissions and all the connections needed.</p>"},{"location":"pubsub/pubsub-migration-2_0/#appendixreferences","title":"Appendix/References","text":"<p>ITO Infrastructure Service Portal: Link</p> <p>Pub/Sub Terraform Repo: Link</p> <p>Gcloud commands to publish/Subscribe:</p> <ol> <li>Create Topic:</li> </ol> <pre><code>gcloud pubsub topics create migration-test-topic --impersonate-service-account=&lt;service-account&gt;\n</code></pre> <ol> <li>Create Subscription:</li> </ol> <pre><code>gcloud pubsub subscriptions create migration-test --topic=migration-test-topic --impersonate-service-account=&lt;service-account&gt;\n</code></pre> <ol> <li>Publish few messages to test topic. Run this command multiple time to publish n number of message</li> </ol> <pre><code>gcloud pubsub topics publish migration-test-topic \\\n--message='Test Message for Migration' --impersonate-service-account=&lt;service account&gt;\n</code></pre> <ol> <li>Subscribe messages from test-topic</li> </ol> <pre><code>gcloud pubsub subscriptions pull migration-test --impersonate-service-account=&lt;service account&gt; --auto-ack --limit=2\n</code></pre> <ol> <li>Monitor the Subscription metrics to see there are 0 Unack messages. Run the subscription command till all the messages are subscribed and acknowledged</li> </ol> <p> </p>"},{"location":"pubsub/pubsub-monitoring/","title":"Pub/Sub Monitoring using Notification Channel","text":""},{"location":"pubsub/pubsub-monitoring/#overview","title":"Overview:","text":"<p>Pub/Sub integration to Monitoring Alert Notification Channel setup lets you create automated and programmatic workflows in response to alerts. Pub/Sub is a publish/subscribe queue that lets you build loosely coupled applications. Using Pub/Sub as your notification channel makes it easy to integrate with third-party providers for alerting and incident response workflows, you can use the Pub/Sub as a notification channel through the API and the Google Cloud Console. This is still in Beta phase.</p>"},{"location":"pubsub/pubsub-monitoring/#dependencies","title":"Dependencies:","text":"<ul> <li>PubSub Topic created</li> <li>PubSub Subscription created</li> <li>Permission to create monitoring alert</li> </ul> <p>Google Doc to create Alert for Notification Channel setup Link</p>"},{"location":"pubsub/pubsub-monitoring/#terraform-procedure","title":"Terraform Procedure:","text":"<p>Here is the link to terraform example module.</p> <pre><code>terraform init\nterraform validate\nterraform plan\nterraform apply\n</code></pre> <ul> <li>Now you are ready to consume your resource</li> </ul>"},{"location":"pubsub/pubsub-monitoring/#disclaimer","title":"Disclaimer:","text":"<p>If you want to delete your resources please USE below command</p> <pre><code>terraform destroy\n</code></pre>"},{"location":"pubsub/pubsub-multiregion/","title":"Regions Available to use for pubsub multi-region storage policy","text":"S.no Description Region 1 For South Carolina, USA as Store Region <code>\"us-central1\"</code> 2 For N. Virginia, USA as Store Region <code>\"us-east4\"</code> 3 For London, Europe as Store Region <code>\"europe-west2\"</code> 4 For Frankfurt, Europe. as Store Region <code>\"europe-west3\"</code> 5 For Mumbai, India. as a Store Region <code>\"asia-south1\"</code> 6 For Delhi, India. as Store Region <code>\"asia-south2\"</code> 7 For Singapore as Store Region <code>\"asia-southeast1\"</code>"},{"location":"pubsub/pubsub-multiregion/#description","title":"Description:","text":"<ul> <li>To enable and use above storage regions please modify message storage policy in terraform example.</li> <li> <p>For Single Region please specify any one region, for multi region storage policy please specify the regions in list format. the example is provided below</p> </li> <li> <p>For single-region storage policy</p> </li> </ul> <pre><code>message_storage_policy = {\n    allowed_persistence_regions = [\"us-central1\"] #[\"europe-west3\"], [\"europe-west2\"], [\"asia-southeast1\"], [\"asia-south1\"], [\"asia-south2\"]\n  }\n</code></pre> <ul> <li>For multi-region storage policy ```tf message_storage_policy = {     allowed_persistence_regions = [\"us-central1\", \"europe-west3\", \"asia-south1\"] #[\"europe-west3\"], [\"europe-west2\"], [\"asia-southeast1\"], [\"asia-south1\"], [\"asia-south2\"]   }</li> </ul>"}]}